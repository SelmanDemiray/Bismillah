<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neural Forge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .section { display: none; }
        .section.active { display: block; }
        .nav-link { transition: all 0.2s ease-in-out; }
        .nav-link.active { background-color: #4f46e5; color: white; }
        .locked-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(30,41,59,0.85); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; text-align: center; color: white; z-index: 10; }
    </style>
</head>
<body class="bg-slate-900 text-gray-200">

    <div class="flex h-screen">
        <!-- Sidebar Navigation -->
        <aside class="w-64 bg-slate-800 p-6 flex flex-col justify-between">
            <div>
                <h1 class="text-3xl font-bold text-white mb-10">Neural Forge</h1>
                <nav class="space-y-2">
                    <a href="#home" class="nav-link block px-4 py-2 rounded-lg text-lg font-medium hover:bg-slate-700">Home</a>
                    <a href="#designer" class="nav-link block px-4 py-2 rounded-lg text-lg font-medium hover:bg-slate-700">Designer</a>
                    <a href="#datasets" class="nav-link block px-4 py-2 rounded-lg text-lg font-medium hover:bg-slate-700">Datasets</a>
                    <a href="#training" class="nav-link block px-4 py-2 rounded-lg text-lg font-medium hover:bg-slate-700">Training</a>
                    <a href="#inference" class="nav-link block px-4 py-2 rounded-lg text-lg font-medium hover:bg-slate-700">Inference</a>
                </nav>
            </div>
            <div class="text-xs text-slate-500">
                <p>Version 0.1.0-alpha</p>
                <p>&copy; 2024 Your Company</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto relative">
            <!-- Home Section -->
            <section id="home" class="section">
                <h2 class="text-4xl font-bold mb-6">Welcome to Neural Forge</h2>
                <p class="text-lg text-gray-400 mb-8">Your all-in-one platform for designing, training, and deploying neural networks with our proprietary, high-performance Rust engine.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-slate-800 p-6 rounded-lg">
                        <h3 class="font-bold text-xl mb-2">Image Classification Model (CNN)</h3>
                        <p class="text-gray-400 text-sm">A classic Convolutional Neural Network for identifying objects in images. Pre-configured for CIFAR-10.</p>
                        <button class="mt-4 bg-indigo-600 px-4 py-2 rounded-lg hover:bg-indigo-500 transition-colors" onclick="copyDesign('cnn')">Use This Model</button>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-lg">
                        <h3 class="font-bold text-xl mb-2">Sentiment Analysis (RNN)</h3>
                        <p class="text-gray-400 text-sm">A Recurrent Neural Network for text sentiment analysis. Ready for IMDB reviews.</p>
                        <button class="mt-4 bg-indigo-600 px-4 py-2 rounded-lg hover:bg-indigo-500 transition-colors" onclick="copyDesign('rnn')">Use This Model</button>
                    </div>
                    <div class="bg-slate-800 p-6 rounded-lg">
                        <h3 class="font-bold text-xl mb-2">Time-Series Forecasting (LSTM)</h3>
                        <p class="text-gray-400 text-sm">An LSTM-based network for predicting future values from historical data.</p>
                        <button class="mt-4 bg-indigo-600 px-4 py-2 rounded-lg hover:bg-indigo-500 transition-colors" onclick="copyDesign('lstm')">Use This Model</button>
                    </div>
                    <!-- more cards omitted for brevity in UI (still present in your original) -->
                </div>
            </section>

            <!-- Designer Section -->
            <section id="designer" class="section relative">
                <!-- Designer lock (kept for parity with other sections, but unlocked by default) -->
                <div class="locked-overlay" id="designer-lock" style="display:none">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold">Designer Locked</h3>
                    </div>
                </div>

                <h2 class="text-4xl font-bold mb-6">Model Designer</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Controls -->
                    <div class="lg:col-span-1 bg-slate-800 p-6 rounded-lg">
                        <h3 class="font-bold text-xl mb-4">Add Layer</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm text-gray-300 mb-1">Type</label>
                                <select id="layer-type" class="w-full bg-slate-700 p-2 rounded">
                                    <option>Dense</option>
                                    <option>Conv2D</option>
                                    <option>Flatten</option>
                                    <option>LSTM</option>
                                    <option>Dropout</option>
                                    <option>Activation</option>
                                </select>
                            </div>
                            <div id="units-container">
                                <label class="block text-sm text-gray-300 mb-1">Units / Filters</label>
                                <input id="layer-units" type="number" class="w-full bg-slate-700 p-2 rounded" value="64">
                            </div>
                            <div id="activation-container">
                                <label class="block text-sm text-gray-300 mb-1">Activation</label>
                                <select id="layer-activation" class="w-full bg-slate-700 p-2 rounded">
                                    <option>ReLU</option>
                                    <option>Sigmoid</option>
                                    <option>Tanh</option>
                                    <option>Softmax</option>
                                    <option>Linear</option>
                                </select>
                            </div>
                            <div id="dropout-container" style="display:none">
                                <label class="block text-sm text-gray-300 mb-1">Dropout Rate</label>
                                <input id="layer-dropout" type="number" step="0.05" min="0" max="1" class="w-full bg-slate-700 p-2 rounded" value="0.5">
                            </div>
                            <div class="flex gap-2">
                                <button id="add-layer-btn" class="flex-1 bg-indigo-600 px-4 py-2 rounded hover:bg-indigo-500">Add Layer</button>
                                <button id="clear-design-btn" class="bg-red-600 px-4 py-2 rounded hover:bg-red-500">Clear</button>
                            </div>
                            <div>
                                <button id="save-design-btn" disabled class="w-full mt-2 bg-green-600 px-4 py-2 rounded-lg hover:bg-green-500">Save Design</button>
                            </div>
                        </div>
                    </div>

                    <!-- Layers list and summary -->
                    <div class="lg:col-span-2">
                        <div class="bg-slate-800 p-4 rounded-lg mb-4">
                            <h3 class="font-bold text-lg mb-2">Layers</h3>
                            <div id="layers-list"></div>
                        </div>

                        <div class="bg-slate-800 p-4 rounded-lg">
                            <h3 class="font-bold text-lg mb-2">Design Summary</h3>
                            <ol id="summary-list" class="list-decimal list-inside text-gray-300"></ol>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Datasets Section -->
            <section id="datasets" class="section relative">
                <div class="locked-overlay" id="datasets-lock" style="display:none">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold">Datasets Locked</h3>
                        <p class="mt-2 text-gray-300">Design a model first to unlock datasets.</p>
                    </div>
                </div>

                <h2 class="text-4xl font-bold mb-6">Datasets</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-slate-800 p-4 rounded-lg flex items-center justify-between">
                        <div>
                            <h3 class="font-bold text-lg">Image Segmentation</h3>
                            <p class="text-sm text-gray-400">Datasets for pixel-wise image labeling, medical imaging, and more.</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span id="segmentation-status" class="text-sm font-medium text-gray-500">Not Downloaded</span>
                            <button onclick="downloadDataset('segmentation')" class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-500">Download</button>
                        </div>
                    </div>

                    <div class="bg-slate-800 p-4 rounded-lg flex items-center justify-between">
                        <div>
                            <h3 class="font-bold text-lg">CIFAR-10</h3>
                            <p class="text-sm text-gray-400">60,000 32x32 color images in 10 classes. Great for image classification.</p>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span id="cifar10-status" class="text-sm font-medium text-gray-500">Not Downloaded</span>
                            <button onclick="downloadDataset('cifar10')" class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-500">Download</button>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <button id="process-data-btn" onclick="processData()" class="bg-green-600 px-6 py-3 rounded-lg text-lg font-semibold hover:bg-green-500 disabled:bg-gray-500 disabled:cursor-not-allowed" disabled>Process and Prepare Data</button>
                    <button id="personal-data-btn" onclick="uploadPersonalData()" class="bg-yellow-600 px-6 py-3 rounded-lg text-lg font-semibold hover:bg-yellow-500 ml-4">Upload Personal Data</button>
                </div>
            </section>

            <!-- Training Section -->
            <section id="training" class="section relative">
                <div class="locked-overlay" id="training-lock">
                     <div class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                        <h3 class="text-2xl font-bold">Section Locked</h3>
                        <p class="mt-2 text-gray-300">Please design a model before starting the training process.</p>
                    </div>
                 </div>
                <h2 class="text-4xl font-bold mb-6">Model Training & Monitoring</h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Hardware Monitoring -->
                    <div class="lg:col-span-1 bg-slate-800 p-6 rounded-lg">
                        <h3 class="font-bold text-xl mb-4">Live Hardware Stats</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="text-sm font-medium text-gray-400">Total CPU Usage</h4>
                                <div class="bg-slate-700 rounded-full h-2.5 mt-1">
                                    <div id="cpu-total-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                             <div>
                                <h4 class="text-sm font-medium text-gray-400">Memory Usage</h4>
                                <p class="text-lg font-semibold"><span id="mem-used">0</span> / <span id="mem-total">0</span> GB</p>
                            </div>
                             <div>
                                <h4 class="text-sm font-medium text-gray-400">Energy Used (Training)</h4>
                                <p class="text-lg font-semibold"><span id="energy-used">0.0000</span> Wh</p>
                            </div>
                             <div>
                                <h4 class="text-sm font-medium text-gray-400">System Uptime</h4>
                                <p class="text-lg font-semibold" id="uptime">0d 0h 0m 0s</p>
                            </div>
                        </div>
                    </div>
                     <!-- Training Control & Logs -->
                    <div class="lg:col-span-2 bg-slate-800 p-6 rounded-lg">
                        <h3 class="font-bold text-xl mb-4">Training Console</h3>
                        <div class="mb-4">
                            <button id="start-training-btn" class="bg-indigo-600 px-6 py-3 rounded-lg text-lg font-semibold hover:bg-indigo-500">Start Training</button>
                        </div>
                        <div id="training-log" class="bg-black h-64 rounded-md p-4 font-mono text-sm overflow-y-auto">
                            <p class="text-gray-500">&gt; Waiting to start training...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Inference Section -->
            <section id="inference" class="section relative">
                <div class="locked-overlay" id="inference-lock">
                     <div class="text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                        <h3 class="text-2xl font-bold">Section Locked</h3>
                        <p class="mt-2 text-gray-300">Please train a model before running inference tests.</p>
                    </div>
                 </div>
                <h2 class="text-4xl font-bold mb-6">Inference Testing</h2>
                <p class="text-gray-400">Test your trained model with new data.</p>
            </section>

        </main>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8080';

        // --- State Management ---
        const appState = {
            modelDesigned: false,
            datasetDownloaded: false,
            datasetProcessed: false,
            modelTrained: false,
        };

        // Designer state
        const designerState = { layers: [] };

        // --- Utility functions ---
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const sec = document.getElementById(id);
            if (sec) sec.classList.add('active');

            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            const nav = document.querySelector(`.nav-link[href="#${id}"]`);
            if (nav) nav.classList.add('active');
        }

        function logToConsole(message, type = 'info') {
            const logEl = document.getElementById('training-log');
            if (!logEl) return;
            const p = document.createElement('p');
            if (type === 'error') p.className = 'text-red-400';
            else if (type === 'success') p.className = 'text-green-400';
            else p.className = 'text-gray-300';
            p.textContent = `> ${new Date().toLocaleTimeString()}: ${message}`;
            logEl.appendChild(p);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function formatBytes(bytes) {
            if (!bytes) return '0 B';
            const i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)), 10);
            return `${(bytes / Math.pow(1024, i)).toFixed(2)} ${['B','KB','MB','GB','TB'][i]}`;
        }
        function formatUptime(seconds) {
            const d = Math.floor(seconds / (3600*24));
            const h = Math.floor(seconds % (3600*24) / 3600);
            const m = Math.floor(seconds % 3600 / 60);
            const s = Math.floor(seconds % 60);
            return `${d}d ${h}h ${m}m ${s}s`;
        }

        // --- State / UI updates ---
        function updateUIState() {
            // Ensure overlay elements exist
            const designerLock = document.getElementById('designer-lock');
            const datasetsLock = document.getElementById('datasets-lock');
            const trainingLock = document.getElementById('training-lock');
            const inferenceLock = document.getElementById('inference-lock');

            if (designerLock) designerLock.style.display = 'none'; // designer always unlocked
            if (datasetsLock) datasetsLock.style.display = appState.modelDesigned ? 'none' : 'flex';
            if (trainingLock) trainingLock.style.display = appState.datasetProcessed ? 'none' : 'flex';
            if (inferenceLock) inferenceLock.style.display = appState.modelTrained ? 'none' : 'flex';

            const processBtn = document.getElementById('process-data-btn');
            if (processBtn) processBtn.disabled = !appState.datasetDownloaded;

            const saveBtn = document.getElementById('save-design-btn');
            if (saveBtn) saveBtn.disabled = designerState.layers.length === 0;
        }

        // --- Dataset logic ---
        function downloadDataset(datasetName) {
            const statusEl = document.getElementById(`${datasetName}-status`);
            if (!statusEl) return;
            statusEl.textContent = 'Downloading...';
            statusEl.classList.remove('text-gray-500');
            statusEl.classList.add('text-yellow-400');
            setTimeout(() => {
                statusEl.textContent = 'Downloaded & Verified';
                statusEl.classList.remove('text-yellow-400');
                statusEl.classList.add('text-green-400');
                appState.datasetDownloaded = true;
                updateUIState();
            }, 1200);
        }

        async function processData() {
            if (!appState.datasetDownloaded) return alert('Please download a dataset first.');
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const fd = new FormData();
                fd.append('dataset', file);
                try {
                    const res = await fetch(`${API_BASE_URL}/api/process_dataset`, { method: 'POST', body: fd });
                    const result = await res.json();
                    if (result.status === 'success') {
                        appState.datasetProcessed = true;
                        updateUIState();
                        alert('Data processed successfully. Training unlocked.');
                    } else {
                        alert('Error: ' + (result.message || 'Unknown'));
                    }
                } catch (err) {
                    alert('Failed to process data: ' + err);
                }
            };
            input.click();
        }

        async function uploadPersonalData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const fd = new FormData();
                fd.append('dataset', file, 'personal.json');
                try {
                    const res = await fetch(`${API_BASE_URL}/api/process_dataset`, { method: 'POST', body: fd });
                    const result = await res.json();
                    if (result.status === 'success') {
                        appState.datasetProcessed = true;
                        updateUIState();
                        alert('Personal data processed. Training unlocked.');
                    } else {
                        alert('Error: ' + (result.message || 'Unknown'));
                    }
                } catch (err) {
                    alert('Failed to upload: ' + err);
                }
            };
            input.click();
        }

        // --- Training logic ---
        async function startTraining() {
            logToConsole('Initializing training sequence...');
            try {
                const response = await fetch(`${API_BASE_URL}/api/train`);
                const data = await response.json();
                if (data.status === 'success') {
                    logToConsole(data.message, 'success');
                    setTimeout(() => {
                        logToConsole('Training complete! Model is ready for inference.', 'success');
                        appState.modelTrained = true; updateUIState();
                    }, 4000);
                } else {
                    logToConsole('Error: ' + (data.message || 'Unknown'), 'error');
                }
            } catch (err) {
                logToConsole('Failed to connect to backend: ' + err, 'error');
            }
        }

        // --- Hardware Monitoring ---
        async function fetchHardwareData() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/hardware`);
                if (!response.ok) return;
                const data = await response.json();
                const totalUsage = Array.isArray(data.cpu_usage) ? (data.cpu_usage.reduce((a,b)=>a+b,0)/data.cpu_usage.length) : (data.cpu_usage || 0);
                const cpuBar = document.getElementById('cpu-total-bar'); if (cpuBar) cpuBar.style.width = `${totalUsage.toFixed(1)}%`;
                const memUsed = document.getElementById('mem-used'); if (memUsed) memUsed.textContent = (data.used_memory ? (data.used_memory/1024/1024/1024).toFixed(2) : '0');
                const memTotal = document.getElementById('mem-total'); if (memTotal) memTotal.textContent = (data.total_memory ? (data.total_memory/1024/1024/1024).toFixed(2) : '0');
                const energy = document.getElementById('energy-used'); if (energy) energy.textContent = (data.energy_consumption_wh || 0).toFixed(4);
                const uptime = document.getElementById('uptime'); if (uptime) uptime.textContent = formatUptime(data.uptime || 0);
            } catch (err) {
                console.error('Error fetching hardware data', err);
            }
        }

        // --- Designer UI functions ---
        function renderLayers() {
            const list = document.getElementById('layers-list');
            const summary = document.getElementById('summary-list');
            if (!list || !summary) return;
            list.innerHTML = '';
            summary.innerHTML = '';
            if (designerState.layers.length === 0) {
                list.innerHTML = '<p class="text-gray-400 mb-2">No layers added yet.</p>';
            } else {
                designerState.layers.forEach((layer, idx) => {
                    let details = '';
                    if (layer.units) details += `<span class="ml-2 text-sm text-gray-300">Units/Filters: ${layer.units}</span>`;
                    if (layer.activation) details += `<span class="ml-2 text-sm text-gray-300">Activation: ${layer.activation}</span>`;
                    if (layer.dropout !== undefined) details += `<span class="ml-2 text-sm text-yellow-300">Rate: ${layer.dropout}</span>`;
                    const div = document.createElement('div');
                    div.className = 'flex items-center justify-between bg-slate-700 rounded-lg px-4 py-2 mb-2';
                    div.innerHTML = `\
                        <span>\
                            <span class=\"font-bold\">${layer.type}</span> ${details}\
                        </span>\
                        <span class=\"flex gap-2\">\
                            <button class=\"text-blue-400 hover:text-blue-600 font-bold\" onclick=\"moveLayerUp(${idx})\">&#8593;</button>\
                            <button class=\"text-blue-400 hover:text-blue-600 font-bold\" onclick=\"moveLayerDown(${idx})\">&#8595;</button>\
                            <button class=\"text-red-400 hover:text-red-600 font-bold\" onclick=\"removeLayer(${idx})\">Remove</button>\
                        </span>`;
                    list.appendChild(div);

                    // summary
                    let txt = `${idx+1}. ${layer.type}`;
                    if (layer.units) txt += ` (${layer.units}` + (layer.activation ? `, ${layer.activation}` : '') + `)`;
                    if (layer.dropout !== undefined) txt += ` (rate: ${layer.dropout})`;
                    const li = document.createElement('li'); li.textContent = txt; summary.appendChild(li);
                });
            }
            updateUIState();
        }

        function removeLayer(idx) { designerState.layers.splice(idx,1); renderLayers(); }
        function moveLayerUp(idx) { if (idx>0) { [designerState.layers[idx-1], designerState.layers[idx]] = [designerState.layers[idx], designerState.layers[idx-1]]; renderLayers(); } }
        function moveLayerDown(idx) { if (idx < designerState.layers.length-1) { [designerState.layers[idx+1], designerState.layers[idx]] = [designerState.layers[idx], designerState.layers[idx+1]]; renderLayers(); } }

        function copyDesign(type) {
            let layers = [];
            if (type === 'cnn') layers = [ {type:'Conv2D', units:32, activation:'ReLU'}, {type:'Conv2D', units:64, activation:'ReLU'}, {type:'Flatten'}, {type:'Dense', units:128, activation:'ReLU'}, {type:'Dropout', dropout:0.5}, {type:'Dense', units:10, activation:'Softmax'} ];
            else if (type === 'rnn') layers = [ {type:'LSTM', units:128, activation:'Tanh'}, {type:'Dense', units:1, activation:'Sigmoid'} ];
            else if (type === 'lstm') layers = [ {type:'LSTM', units:64, activation:'Tanh'}, {type:'Dense', units:32, activation:'ReLU'}, {type:'Dense', units:1, activation:'Linear'} ];
            designerState.layers = layers; renderLayers(); appState.modelDesigned = true; updateUIState(); showSection('designer'); alert('Design copied! You can now edit or train this model.');
        }

        // --- Init and event wiring ---
        window.addEventListener('DOMContentLoaded', () => {
            const initialHash = window.location.hash.substring(1) || 'home';
            showSection(initialHash);

            // nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const sectionId = e.target.getAttribute('href').substring(1);
                    window.location.hash = sectionId;
                    showSection(sectionId);
                });
            });

            // layer UI wiring
            const typeEl = document.getElementById('layer-type');
            const unitsContainer = document.getElementById('units-container');
            const activationContainer = document.getElementById('activation-container');
            const dropoutContainer = document.getElementById('dropout-container');

            if (typeEl) {
                typeEl.addEventListener('change', (e) => {
                    const type = e.target.value;
                    unitsContainer.style.display = (type === 'Dense' || type === 'Conv2D' || type === 'LSTM') ? '' : 'none';
                    activationContainer.style.display = (type === 'Dense' || type === 'Conv2D' || type === 'LSTM' || type === 'Activation') ? '' : 'none';
                    dropoutContainer.style.display = (type === 'Dropout') ? '' : 'none';
                });
                typeEl.dispatchEvent(new Event('change'));
            }

            const addBtn = document.getElementById('add-layer-btn');
            if (addBtn) addBtn.addEventListener('click', () => {
                const type = document.getElementById('layer-type').value;
                let layer = { type };
                if (type === 'Dense' || type === 'Conv2D' || type === 'LSTM') {
                    layer.units = parseInt(document.getElementById('layer-units').value,10) || 0;
                    layer.activation = document.getElementById('layer-activation').value;
                }
                if (type === 'Dropout') layer.dropout = parseFloat(document.getElementById('layer-dropout').value) || 0;
                if (type === 'Activation') layer.activation = document.getElementById('layer-activation').value;
                designerState.layers.push(layer); renderLayers();
            });

            const saveBtn = document.getElementById('save-design-btn');
            if (saveBtn) saveBtn.addEventListener('click', () => { appState.modelDesigned = true; updateUIState(); alert('Model design saved! You can now select and process a dataset.'); });

            const clearBtn = document.getElementById('clear-design-btn');
            if (clearBtn) clearBtn.addEventListener('click', () => { designerState.layers = []; renderLayers(); appState.modelDesigned = false; updateUIState(); });

            const startTrainingBtn = document.getElementById('start-training-btn');
            if (startTrainingBtn) startTrainingBtn.addEventListener('click', startTraining);

            // process/upload buttons are inline using onclick attributes already, but ensure handlers exist globally
            window.downloadDataset = downloadDataset;
            window.processData = processData;
            window.uploadPersonalData = uploadPersonalData;
            window.copyDesign = copyDesign;

            // start hardware polling
            fetchHardwareData();
            setInterval(fetchHardwareData, 2000);

            updateUIState();
            renderLayers();
        });

    </script>
</body>
</html>

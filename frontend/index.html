<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroForge Studio - Rust AI Backend</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #1a1b26;
            --sidebar-bg: #24283b;
            --canvas-bg: #1e1f29;
            --primary-accent: #7aa2f7;
            --secondary-accent: #bb9af7;
            --text-color: #c0caf5;
            --text-dim: #a9b1d6;
            --border-color: #414868;
            --success-color: #9ece6a;
            --error-color: #f7768e;
            --font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Main Layout --- */
        #app-container {
            display: flex;
            width: 100%;
            height: 100%;
        }

        #layer-palette {
            width: 250px;
            background-color: var(--sidebar-bg);
            padding: 20px;
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
        }

        #main-workspace {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        #properties-panel {
            width: 300px;
            background-color: var(--sidebar-bg);
            padding: 20px;
            border-left: 1px solid var(--border-color);
            overflow-y: auto;
        }

        h1, h2, h3 {
            color: var(--primary-accent);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
        }

        h3 {
            color: var(--secondary-accent);
            font-size: 1.1em;
        }

        /* --- Layer Palette --- */
        .layer-category h3 {
            margin-bottom: 10px;
        }
        .draggable-layer {
            background-color: var(--canvas-bg);
            border: 1px solid var(--border-color);
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: grab;
            transition: all 0.2s ease;
            text-align: center;
            font-weight: 500;
        }
        .draggable-layer:hover {
            border-color: var(--primary-accent);
            background-color: #2a2f4a;
        }

        /* --- Main Workspace Tabs --- */
        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-dim);
            font-size: 1em;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            color: var(--primary-accent);
            border-bottom: 3px solid var(--primary-accent);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* --- Design Canvas --- */
        #design-canvas {
            background-color: var(--canvas-bg);
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            min-height: 400px;
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }
        .canvas-layer {
            background-color: var(--sidebar-bg);
            border: 1px solid var(--border-color);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .canvas-layer.selected {
            border-color: var(--secondary-accent);
            box-shadow: 0 0 10px rgba(187, 154, 247, 0.3);
        }
        .canvas-layer .layer-name { font-weight: bold; }
        .canvas-layer .layer-details { color: var(--text-dim); font-size: 0.9em; }

        /* --- Properties Panel & Form Elements --- */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-dim);
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px;
            background-color: var(--canvas-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
            box-sizing: border-box;
        }
        
        /* --- Training Tab --- */
        #training-controls, #training-status {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .btn-primary {
            background-color: var(--primary-accent);
            color: var(--bg-color);
        }
        .btn-primary:hover {
            opacity: 0.9;
        }
        .btn-danger {
            background-color: var(--error-color);
            color: var(--bg-color);
        }
        #training-log {
            margin-top: 20px;
            background: var(--canvas-bg);
            border-radius: 5px;
            padding: 15px;
            height: 150px;
            overflow-y: scroll;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            border: 1px solid var(--border-color);
        }
        #training-progress {
            width: 100%;
            appearance: none;
            height: 10px;
            border-radius: 5px;
            background: var(--border-color);
        }
        #training-progress::-webkit-progress-bar {
            background: var(--border-color);
            border-radius: 5px;
        }
        #training-progress::-webkit-progress-value {
            background: var(--success-color);
            border-radius: 5px;
        }

        /* --- Inspect Tab --- */
        #inspect-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(20px, 1fr));
            gap: 2px;
            background: var(--canvas-bg);
            padding: 5px;
            border: 1px solid var(--border-color);
            max-height: 400px;
            overflow: auto;
        }
        .grid-cell {
            width: 100%;
            padding-bottom: 100%; /* Aspect ratio hack */
            position: relative;
        }
        .grid-cell-content {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            background-color: #333;
        }

    </style>
</head>
<body>

    <div id="app-container">
        <aside id="layer-palette">
            <h1>NeuroForge</h1>
            
            <div class="layer-category">
                <h3>Core Layers</h3>
                <div class="draggable-layer" draggable="true" data-layer-type="Dense">Dense</div>
                <div class="draggable-layer" draggable="true" data-layer-type="Activation">Activation</div>
                <div class="draggable-layer" draggable="true" data-layer-type="Flatten">Flatten</div>
                <div class="draggable-layer" draggable="true" data-layer-type="Dropout">Dropout</div>
            </div>

            <div class="layer-category">
                <h3>Convolutional</h3>
                <div class="draggable-layer" draggable="true" data-layer-type="Conv2D">Conv2D</div>
                <div class="draggable-layer" draggable="true" data-layer-type="MaxPooling2D">MaxPooling2D</div>
                <div class="draggable-layer" draggable="true" data-layer-type="AveragePooling2D">AveragePooling2D</div>
            </div>
            
            <div class="layer-category">
                <h3>Recurrent</h3>
                <div class="draggable-layer" draggable="true" data-layer-type="LSTM">LSTM</div>
                <div class="draggable-layer" draggable="true" data-layer-type="GRU">GRU</div>
                <div class="draggable-layer" draggable="true" data-layer-type="Embedding">Embedding</div>
            </div>

            <div class="layer-category">
                <h3>Transformer Blocks</h3>
                <div class="draggable-layer" draggable="true" data-layer-type="MultiHeadAttention">Multi-Head Attention</div>
                <div class="draggable-layer" draggable="true" data-layer-type="LayerNorm">Layer Normalization</div>
                <div class="draggable-layer" draggable="true" data-layer-type="PositionalEncoding">Positional Encoding</div>
                <div class="draggable-layer" draggable="true" data-layer-type="EncoderBlock">Encoder Block</div>
                <div class="draggable-layer" draggable="true" data-layer-type="DecoderBlock">Decoder Block</div>
            </div>
        </aside>

        <main id="main-workspace">
            <nav class="tab-nav">
                <button class="tab-button active" data-tab="design">Design</button>
                <button class="tab-button" data-tab="train">Train</button>
                <button class="tab-button" data-tab="inspect">Inspect</button>
            </nav>

            <div id="design-tab" class="tab-content active">
                <h2>Model Architecture</h2>
                <div id="design-canvas">
                    </div>
            </div>

            <div id="train-tab" class="tab-content">
                <h2>Training Dashboard</h2>
                <div id="training-controls">
                    <div class="form-group">
                        <label for="model-name">Model Name</label>
                        <input type="text" id="model-name" value="custom_model">
                    </div>
                    <div class="form-group">
                        <label for="learning-rate">Learning Rate</label>
                        <input type="number" id="learning-rate" value="0.001" step="0.0001">
                    </div>
                    <div class="form-group">
                        <label for="epochs">Epochs</label>
                        <input type="number" id="epochs" value="10">
                    </div>
                    <div class="form-group">
                        <label for="batch-size">Batch Size</label>
                        <input type="number" id="batch-size" value="32">
                    </div>
                </div>
                <div>
                    <button id="start-train-btn" class="button btn-primary">Start Training</button>
                    <button id="stop-train-btn" class="button btn-danger">Stop Training</button>
                </div>
                <div id="training-status">
                    <div>
                        <h3>Progress</h3>
                        <p>Epoch: <span id="current-epoch">0</span>/<span id="total-epochs">10</span></p>
                        <progress id="training-progress" value="0" max="100"></progress>
                        <p>Loss: <span id="current-loss">N/A</span> | Accuracy: <span id="current-accuracy">N/A</span></p>
                    </div>
                    <div>
                        <h3>Training Chart</h3>
                        <canvas id="training-chart"></canvas>
                    </div>
                </div>
                <h3>Training Log</h3>
                <div id="training-log"></div>
            </div>

            <div id="inspect-tab" class="tab-content">
                <h2>Inspect Model Parameters</h2>
                <div class="form-group">
                    <label for="inspect-layer-select">Select Layer</label>
                    <select id="inspect-layer-select">
                        </select>
                </div>
                <div class="form-group">
                    <label for="inspect-param-select">Select Parameter</label>
                    <select id="inspect-param-select">
                        <option value="weights">Weights</option>
                        <option value="biases">Biases</option>
                    </select>
                </div>
                <h3>Matrix/Vector Visualization (Conceptual)</h3>
                <p style="color: var(--text-dim); font-style: italic;">This is a visual mock-up. A real implementation would fetch and render the actual tensor data from the backend.</p>
                <div id="inspect-grid">
                    </div>
            </div>
        </main>

        <aside id="properties-panel">
            <h2>Properties</h2>
            <div id="properties-content">
                <p>Select a layer on the canvas to edit its properties.</p>
            </div>
        </aside>

    </div>

<script>
    // --- Application State ---
    let modelArchitecture = [];
    let selectedLayerId = null;
    let trainingStatusInterval = null;
    let trainingChart = null;

    // --- DOM Elements ---
    const layerPalette = document.getElementById('layer-palette');
    const designCanvas = document.getElementById('design-canvas');
    const propertiesContent = document.getElementById('properties-content');
    const startTrainBtn = document.getElementById('start-train-btn');
    const trainingLog = document.getElementById('training-log');
    const inspectLayerSelect = document.getElementById('inspect-layer-select');

    // --- Layer Definitions ---
    const layerDefs = {
        'Dense': [
            { name: 'units', type: 'number', default: 128 },
            { name: 'activation', type: 'select', options: ['ReLU', 'Sigmoid', 'Tanh', 'Linear', 'GELU'], default: 'ReLU' }
        ],
        'Conv2D': [
            { name: 'filters', type: 'number', default: 32 },
            { name: 'kernel_size', type: 'number', default: 3 },
            { name: 'stride', type: 'number', default: 1 }
        ],
        'MaxPooling2D': [
            { name: 'pool_size', type: 'number', default: 2 },
            { name: 'stride', type: 'number', default: 2 }
        ],
        'LSTM': [
            { name: 'units', type: 'number', default: 64 }
        ],
        'Dropout': [
            { name: 'rate', type: 'number', default: 0.5, step: 0.1 }
        ],
        'MultiHeadAttention': [
            { name: 'num_heads', type: 'number', default: 8 },
            { name: 'key_dim', type: 'number', default: 64 }
        ],
        // Default for layers with no editable params
        'default': []
    };

    // --- Drag and Drop Logic ---
    layerPalette.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('draggable-layer')) {
            e.dataTransfer.setData('text/plain', e.target.dataset.layerType);
        }
    });

    designCanvas.addEventListener('dragover', (e) => {
        e.preventDefault(); // Allow dropping
    });

    designCanvas.addEventListener('drop', (e) => {
        e.preventDefault();
        const layerType = e.dataTransfer.getData('text/plain');
        addLayerToArchitecture(layerType);
    });

    function addLayerToArchitecture(layerType) {
        const layerId = `layer_${Date.now()}`;
        const layerProps = layerDefs[layerType] || layerDefs['default'];
        
        const newLayer = {
            id: layerId,
            type: layerType,
            properties: {}
        };
        // Set default properties
        layerProps.forEach(prop => {
            newLayer.properties[prop.name] = prop.default;
        });

        modelArchitecture.push(newLayer);
        renderModelCanvas();
        logToConsole(`Added ${layerType} layer.`);
    }

    // --- Rendering Logic ---
    function renderModelCanvas() {
        designCanvas.innerHTML = '';
        if (modelArchitecture.length === 0) {
            designCanvas.innerHTML = '<p style="text-align:center; color: var(--text-dim);">Drag layers from the left palette to build your model.</p>';
        }

        modelArchitecture.forEach(layer => {
            const layerEl = document.createElement('div');
            layerEl.className = 'canvas-layer';
            layerEl.dataset.layerId = layer.id;
            if (layer.id === selectedLayerId) {
                layerEl.classList.add('selected');
            }

            const details = Object.entries(layer.properties)
                .map(([key, value]) => `${key}: ${value}`)
                .join(', ');

            layerEl.innerHTML = `
                <span class="layer-name">${layer.type}</span>
                <span class="layer-details">${details}</span>
            `;
            layerEl.addEventListener('click', () => {
                selectedLayerId = layer.id;
                renderModelCanvas(); // Re-render to show selection
                renderPropertiesPanel();
            });
            designCanvas.appendChild(layerEl);
        });

        updateInspectLayerSelect();
    }

    function renderPropertiesPanel() {
        if (!selectedLayerId) {
            propertiesContent.innerHTML = '<p>Select a layer on the canvas to edit its properties.</p>';
            return;
        }

        const layer = modelArchitecture.find(l => l.id === selectedLayerId);
        if (!layer) return;

        propertiesContent.innerHTML = `<h3>${layer.type} Properties</h3>`;
        const layerProps = layerDefs[layer.type] || layerDefs['default'];

        if (layerProps.length === 0) {
            propertiesContent.innerHTML += `<p>No configurable properties for this layer.</p>`;
        }

        layerProps.forEach(prop => {
            const group = document.createElement('div');
            group.className = 'form-group';
            
            const label = document.createElement('label');
            label.textContent = prop.name.replace(/_/g, ' ');
            group.appendChild(label);
            
            let input;
            if (prop.type === 'select') {
                input = document.createElement('select');
                prop.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    if (layer.properties[prop.name] === opt) {
                        option.selected = true;
                    }
                    input.appendChild(option);
                });
            } else {
                input = document.createElement('input');
                input.type = prop.type;
                input.value = layer.properties[prop.name];
                if (prop.step) input.step = prop.step;
            }

            input.addEventListener('change', (e) => {
                const value = prop.type === 'number' ? parseFloat(e.target.value) : e.target.value;
                layer.properties[prop.name] = value;
                renderModelCanvas(); // Update details on canvas
            });

            group.appendChild(input);
            propertiesContent.appendChild(group);
        });
    }

    // --- Tab Switching Logic ---
    document.querySelector('.tab-nav').addEventListener('click', (e) => {
        if (e.target.classList.contains('tab-button')) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            e.target.classList.add('active');
            document.getElementById(`${e.target.dataset.tab}-tab`).classList.add('active');
        }
    });

    // --- Training Logic ---
    startTrainBtn.addEventListener('click', () => {
        logToConsole('Initiating training request...');
        if (modelArchitecture.length === 0) {
            logToConsole('ERROR: Cannot start training. Model architecture is empty.', 'error');
            return;
        }

        const params = {
            model_name: document.getElementById('model-name').value,
            epochs: parseInt(document.getElementById('epochs').value),
            batch_size: parseInt(document.getElementById('batch-size').value),
            learning_rate: parseFloat(document.getElementById('learning-rate').value),
            // In a real application, you would send the detailed architecture
            architecture: modelArchitecture
        };

        // This is where you would send the 'params' object to your backend.
        // The current Rust backend only accepts a simplified version.
        // We will call it with the simplified params for demonstration.
        const simplifiedParams = {
            model_name: params.model_name,
            epochs: params.epochs,
            batch_size: params.batch_size,
            learning_rate: params.learning_rate,
        };

        fetch('http://127.0.0.1:8080/api/train', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(simplifiedParams)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                logToConsole('Backend acknowledged training request. Starting status polling...');
                startStatusPolling();
                initializeChart();
            } else {
                logToConsole(`Error starting training: ${data.message}`, 'error');
            }
        })
        .catch(err => {
            logToConsole(`FATAL: Could not connect to backend. Is it running? ${err}`, 'error');
        });
    });

    function startStatusPolling() {
        if (trainingStatusInterval) clearInterval(trainingStatusInterval);

        trainingStatusInterval = setInterval(() => {
            fetch('http://127.0.0.1:8080/api/train/status')
                .then(response => response.json())
                .then(status => {
                    updateTrainingUI(status);
                    if (!status.is_training) {
                        logToConsole('Training finished!');
                        clearInterval(trainingStatusInterval);
                    }
                })
                .catch(err => {
                    logToConsole('Polling failed. Stopping.', 'error');
                    clearInterval(trainingStatusInterval);
                });
        }, 1500); // Poll every 1.5 seconds
    }

    function updateTrainingUI(status) {
        logToConsole(status.message);
        document.getElementById('current-epoch').textContent = status.epoch;
        document.getElementById('total-epochs').textContent = status.max_epochs;
        document.getElementById('current-loss').textContent = status.loss.toFixed(4);
        document.getElementById('current-accuracy').textContent = status.accuracy.toFixed(4);
        
        const progress = status.max_epochs > 0 ? (status.epoch / status.max_epochs) * 100 : 0;
        document.getElementById('training-progress').value = progress;

        // Update chart
        if (trainingChart && status.epoch > 0) {
            if (!trainingChart.data.labels.includes(status.epoch)) {
                trainingChart.data.labels.push(status.epoch);
                trainingChart.data.datasets[0].data.push(status.loss);
                trainingChart.data.datasets[1].data.push(status.accuracy);
                trainingChart.update();
            }
        }
    }

    function initializeChart() {
        const ctx = document.getElementById('training-chart').getContext('2d');
        if(trainingChart) {
            trainingChart.destroy();
        }
        trainingChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Loss',
                    data: [],
                    borderColor: 'rgba(247, 118, 142, 1)', // error color
                    yAxisID: 'yLoss',
                }, {
                    label: 'Accuracy',
                    data: [],
                    borderColor: 'rgba(158, 206, 106, 1)', // success color
                    yAxisID: 'yAccuracy',
                }]
            },
            options: {
                scales: {
                    yLoss: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Loss' } },
                    yAccuracy: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Accuracy' }, min: 0, max: 1 }
                }
            }
        });
    }

    // --- Inspect Logic ---
    function updateInspectLayerSelect() {
        inspectLayerSelect.innerHTML = '';
        modelArchitecture.forEach((layer, index) => {
            const option = document.createElement('option');
            option.value = layer.id;
            option.textContent = `${index}: ${layer.type}`;
            inspectLayerSelect.appendChild(option);
        });
        renderInspectGrid();
    }

    function renderInspectGrid() {
        const grid = document.getElementById('inspect-grid');
        grid.innerHTML = '';
        const numCells = Math.floor(Math.random() * 50) + 10; // Mock data
        for (let i = 0; i < numCells; i++) {
            const cell = document.createElement('div');
            cell.className = 'grid-cell';
            const value = (Math.random() * 2 - 1).toFixed(2);
            cell.innerHTML = `<div class="grid-cell-content" style="background-color: rgba(122, 162, 247, ${Math.abs(parseFloat(value))})">${value}</div>`;
            grid.appendChild(cell);
        }
    }
    
    inspectLayerSelect.addEventListener('change', renderInspectGrid);
    document.getElementById('inspect-param-select').addEventListener('change', renderInspectGrid);


    // --- Utility Functions ---
    function logToConsole(message, type = 'info') {
        const p = document.createElement('p');
        const timestamp = new Date().toLocaleTimeString();
        p.textContent = `[${timestamp}] ${message}`;
        if (type === 'error') {
            p.style.color = 'var(--error-color)';
        }
        trainingLog.appendChild(p);
        trainingLog.scrollTop = trainingLog.scrollHeight;
    }

    // --- Initial Render ---
    renderModelCanvas();
    renderPropertiesPanel();
    updateInspectLayerSelect();
    
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Neural Forge — Designer (Ultimate)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .section { display: none; }
    .section.active { display: block; }
    .nav-link { transition: all 0.2s ease-in-out; }
    .nav-link.active { background-color: #4f46e5; color: white; }
    .locked-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(30,41,59,0.85); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; text-align: center; color: white; z-index: 10; }
    #designer-canvas { background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent); border-radius: 8px; }
    .layer-box { cursor: pointer; }
    .param-key { color: #94a3b8; }
    .toolbar-btn { transition: transform .08s; }
    .toolbar-btn:active { transform: scale(.98); }
  </style>
</head>
<body class="bg-slate-900 text-gray-200">
  <div class="flex h-screen">
    <aside class="w-64 bg-slate-800 p-6 flex flex-col justify-between">
      <div>
        <h1 class="text-2xl font-bold text-white mb-6">Neural Forge</h1>
        <nav class="space-y-2">
          <a href="#home" class="nav-link block px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-700">Home</a>
          <a href="#designer" class="nav-link block px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-700">Designer</a>
          <a href="#datasets" class="nav-link block px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-700">Datasets</a>
          <a href="#training" class="nav-link block px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-700">Training</a>
          <a href="#inference" class="nav-link block px-4 py-2 rounded-lg text-sm font-medium hover:bg-slate-700">Inference</a>
        </nav>
      </div>
      <div class="text-xs text-slate-500">
        <p>Version 0.3.0 — Ultimate Designer</p>
        <p>&copy; 2025 Neural Forge</p>
      </div>
    </aside>

    <main class="flex-1 p-6 overflow-y-auto relative">
      <!-- Home -->
      <section id="home" class="section active">
        <h2 class="text-3xl font-bold mb-4">Neural Forge — Ultimate Designer</h2>
        <p class="text-gray-400 mb-6">Full transformer support (encoder-only, decoder-only, encoder-decoder), visual canvas with connections, presets (BERT/GPT/T5/DeepSeek), export/import, validation, local save and advanced editing.</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="bg-slate-800 p-4 rounded-lg">
            <h3 class="font-semibold">Quick Templates</h3>
            <div class="mt-3 space-y-2">
              <button class="w-full bg-indigo-600 px-3 py-2 rounded toolbar-btn" onclick="copyDesign('transformer_encoder')">Transformer — Encoder only (BERT)</button>
              <button class="w-full bg-indigo-600 px-3 py-2 rounded toolbar-btn" onclick="copyDesign('transformer_decoder')">Transformer — Decoder only (GPT)</button>
              <button class="w-full bg-indigo-600 px-3 py-2 rounded toolbar-btn" onclick="copyDesign('transformer_ed')">Transformer — Encoder-Decoder (T5)</button>
              <button class="w-full bg-green-600 px-3 py-2 rounded toolbar-btn" onclick="copyDesign('deepseek')">DeepSeek (research preset)</button>
            </div>
          </div>

          <div class="bg-slate-800 p-4 rounded-lg md:col-span-2">
            <h3 class="font-semibold">What's new</h3>
            <ul class="list-disc pl-5 mt-3 text-gray-300">
              <li>Transformer block with full params (heads, head_dim, ff_dim, dropout, activation, normalization)</li>
              <li>Decoder options: causal attention, cross-attention toggle and mask types</li>
              <li>Visual arrows between layers, reorder by dragging in list, clone, group and parameter search</li>
              <li>Save to LocalStorage and export/import design JSON</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- Designer -->
      <section id="designer" class="section relative">
        <h2 class="text-3xl font-bold mb-4">Model Designer — Visual & Powerful</h2>
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
          <!-- Left controls -->
          <div class="lg:col-span-1 bg-slate-800 p-4 rounded-lg">
            <h3 class="font-semibold mb-2">Add Layer / Block</h3>
            <div class="space-y-2">
              <label class="text-sm text-gray-300">Block Type</label>
              <select id="block-type" class="w-full bg-slate-700 p-2 rounded">
                <option value="Dense">Dense</option>
                <option value="Conv2D">Conv2D</option>
                <option value="Flatten">Flatten</option>
                <option value="Embedding">Embedding</option>
                <option value="PositionalEncoding">PositionalEncoding</option>
                <option value="TransformerBlock">TransformerBlock</option>
                <option value="MultiHeadAttention">MultiHeadAttention</option>
                <option value="LayerNorm">LayerNorm</option>
                <option value="Dropout">Dropout</option>
                <option value="Activation">Activation</option>
                <option value="LSTM">LSTM</option>
                <option value="Concat">Concat</option>
                <option value="ResBlock">ResBlock</option>
              </select>

              <div id="params-area" class="space-y-2 mt-2"></div>

              <div class="flex gap-2">
                <button id="add-block-btn" class="flex-1 bg-indigo-600 px-3 py-2 rounded">Add</button>
                <button id="add-attention-btn" class="bg-blue-600 px-3 py-2 rounded">Add MHA</button>
              </div>

              <div class="mt-3">
                <label class="text-sm text-gray-300">Presets</label>
                <div class="mt-2 space-y-2">
                  <button class="w-full bg-amber-600 px-2 py-1 rounded" onclick="applyPreset('bert')">BERT-small</button>
                  <button class="w-full bg-amber-600 px-2 py-1 rounded" onclick="applyPreset('gpt-lite')">GPT-lite</button>
                  <button class="w-full bg-amber-600 px-2 py-1 rounded" onclick="applyPreset('t5')">T5-small (encoder-decoder)</button>
                  <button class="w-full bg-green-600 px-2 py-1 rounded" onclick="applyPreset('deepseek')">DeepSeek Research</button>
                </div>
              </div>

              <div class="mt-4">
                <button id="export-json-btn" class="w-full bg-slate-700 px-3 py-2 rounded">Export JSON</button>
                <input id="import-json" type="file" accept="application/json" class="hidden" />
                <button id="import-json-btn" class="w-full mt-2 bg-slate-700 px-3 py-2 rounded">Import JSON</button>
                <button id="save-local-btn" class="w-full mt-2 bg-emerald-600 px-3 py-2 rounded">Save to Local</button>
                <button id="load-local-btn" class="w-full mt-2 bg-yellow-600 px-3 py-2 rounded">Load from Local</button>
              </div>

            </div>
          </div>

          <!-- Canvas -->
          <div class="lg:col-span-3">
            <div class="bg-slate-800 p-4 rounded-lg mb-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold">Visual Canvas</h3>
                <div class="flex gap-2">
                  <button id="export-png" class="bg-indigo-600 px-3 py-1 rounded">Export PNG</button>
                  <button id="clear-canvas" class="bg-red-600 px-3 py-1 rounded">Clear</button>
                </div>
              </div>
              <div id="designer-canvas" class="w-full h-64 relative overflow-auto">
                <svg id="canvas-svg" width="1200" height="300"></svg>
              </div>
            </div>

            <div class="bg-slate-800 p-4 rounded-lg">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold">Layers (list)</h3>
                <div class="text-sm text-gray-400">Drag to reorder • Click a layer to edit</div>
              </div>
              <div id="layers-list" class="mt-3 max-h-80 overflow-auto"></div>
            </div>
          </div>
        </div>

        <!-- Layer edit modal -->
        <div id="layer-editor" class="fixed inset-0 flex items-center justify-center bg-black/50 hidden z-50">
          <div class="bg-slate-800 p-4 rounded w-96">
            <h4 id="editor-title" class="font-bold mb-2">Edit Layer</h4>
            <div id="editor-body" class="space-y-2 text-sm text-gray-300"></div>
            <div class="flex justify-between items-center mt-3">
              <div class="text-xs text-gray-400">Tip: use numeric values for numbers</div>
              <div class="flex gap-2">
                <button id="editor-clone" class="bg-slate-700 px-3 py-1 rounded">Clone</button>
                <button id="editor-save" class="bg-green-600 px-3 py-1 rounded">Save</button>
                <button id="editor-cancel" class="bg-red-600 px-3 py-1 rounded">Cancel</button>
              </div>
            </div>
          </div>
        </div>

      </section>

    </main>
  </div>

  <script>
    // --- State ---
    const appState = { modelDesigned:false, datasetDownloaded:false, datasetProcessed:false, modelTrained:false };
    const designer = { layers: [] };
    let editingIndex = -1;

    // --- Helpers ---
    function showSection(id) {
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      const sec = document.getElementById(id); if (sec) sec.classList.add('active');
      document.querySelectorAll('.nav-link').forEach(link=>link.classList.remove('active'));
      const nav = document.querySelector(`.nav-link[href="#${id}"]`); if (nav) nav.classList.add('active');
    }

    // --- Dynamic params UI for block types ---
    const paramsArea = document.getElementById('params-area');
    const blockTypeEl = document.getElementById('block-type');

    function createInput(id, value='', attrs=''){
      const inp = document.createElement('input'); inp.id = id; inp.className='w-full bg-slate-700 p-2 rounded mt-1'; inp.value = value; if (attrs) inp.setAttribute('data-attrs', attrs); return inp;
    }

    function renderParamsFor(type, existingParams = {}){
      paramsArea.innerHTML = '';
      function addField(label, id, val='', attrs=''){
        const wrapper = document.createElement('div'); wrapper.className='text-sm';
        const lab = document.createElement('label'); lab.className='block text-gray-300'; lab.textContent = label;
        const inp = createInput(id, (existingParams[id]!==undefined?existingParams[id]:val), attrs);
        wrapper.appendChild(lab); wrapper.appendChild(inp); paramsArea.appendChild(wrapper);
      }

      if (type === 'Dense'){ addField('Units','param-units',64,'number'); addField('Activation','param-activation','ReLU'); }
      else if (type === 'Conv2D'){ addField('Filters','param-units',32,'number'); addField('Kernel','param-kernel',3,'number'); addField('Activation','param-activation','ReLU'); }
      else if (type === 'Embedding'){ addField('Vocab Size','param-vocab',30000,'number'); addField('Dim','param-units',128,'number'); }
      else if (type === 'PositionalEncoding'){ addField('Max Len','param-maxlen',512,'number'); addField('Dim','param-units',128,'number'); addField('Type','param-pe-type','sinusoidal'); }
      else if (type === 'TransformerBlock'){
        addField('Heads','param-heads',8,'number'); addField('Head Dim','param-headdim',64,'number'); addField('FF Dim','param-ff',2048,'number'); addField('Dropout','param-dropout',0.1,'number'); addField('Activation','param-ff-activation','GELU'); addField('Normalization','param-norm','LayerNorm'); addField('Causal (decoder)','param-causal',false,'checkbox'); addField('Cross-Attention (decoder)','param-cross',false,'checkbox'); }
      else if (type === 'MultiHeadAttention'){ addField('Heads','param-heads',8,'number'); addField('Head Dim','param-headdim',64,'number'); addField('Causal','param-causal',false,'checkbox'); }
      else if (type === 'LayerNorm'){ addField('Epsilon','param-eps',1e-6,'number'); }
      else if (type === 'Dropout'){ addField('Rate','param-dropout',0.5,'number'); }
      else if (type === 'LSTM'){ addField('Units','param-units',128,'number'); addField('Return Sequences','param-returnseq',false,'checkbox'); }
      else if (type === 'Activation'){ addField('Activation','param-activation','ReLU'); }
      else if (type === 'ResBlock'){ addField('Filters','param-units',64,'number'); addField('Repeat','param-repeat',2,'number'); }
      else { addField('Note','param-note','No params'); }

      // Patch checkbox inputs
      paramsArea.querySelectorAll('input').forEach(inp=>{
        if (inp.getAttribute('data-attrs') === 'checkbox'){
          inp.type = 'checkbox'; inp.checked = existingParams[inp.id] === true || existingParams[inp.id] === 'true';
        } else if (inp.getAttribute('data-attrs') === 'number'){
          inp.type = 'number';
        }
      });
    }

    blockTypeEl.addEventListener('change', ()=> renderParamsFor(blockTypeEl.value));
    renderParamsFor(blockTypeEl.value);

    // --- Add block logic ---
    document.getElementById('add-block-btn').addEventListener('click', ()=>{
      const type = blockTypeEl.value; const params = {};
      paramsArea.querySelectorAll('input').forEach(inp=>{
        const key = inp.id.replace('param-','');
        if (inp.type === 'checkbox') params[key] = inp.checked;
        else if (inp.type === 'number') params[key] = parseFloat(inp.value);
        else params[key] = inp.value;
      });
      designer.layers.push({type, params}); renderLayersList(); renderCanvas(); appState.modelDesigned = true;
    });

    document.getElementById('add-attention-btn').addEventListener('click', ()=>{ designer.layers.push({type:'MultiHeadAttention', params:{heads:8, headdim:64}}); renderLayersList(); renderCanvas(); appState.modelDesigned = true; });

    // --- Presets ---
    function applyPreset(name){
      if (name==='bert'){
        designer.layers = [ {type:'Embedding', params:{vocab:30000, units:128}}, {type:'PositionalEncoding', params:{maxlen:512, units:128, 'pe-type':'sinusoidal'}}, {type:'TransformerBlock', params:{heads:8, headdim:64, ff:512, 'param-dropout':0.1, 'param-ff-activation':'GELU'}}, {type:'TransformerBlock', params:{heads:8, headdim:64, ff:512, 'param-dropout':0.1, 'param-ff-activation':'GELU'}}, {type:'LayerNorm', params:{}} ];
      } else if (name==='gpt-lite'){
        designer.layers = [ {type:'Embedding', params:{vocab:30000, units:128}}, {type:'PositionalEncoding', params:{maxlen:512, units:128}}, {type:'TransformerBlock', params:{heads:8, headdim:64, ff:512, 'param-dropout':0.1, 'param-causal':true}}, {type:'TransformerBlock', params:{heads:8, headdim:64, ff:512, 'param-dropout':0.1, 'param-causal':true}} ];
      } else if (name==='t5'){
        designer.layers = [ {type:'Embedding', params:{vocab:32000, units:256}}, {type:'PositionalEncoding', params:{maxlen:512, units:256}}, {type:'TransformerBlock', params:{heads:8, headdim:64, ff:1024, 'param-cross':false}}, {type:'TransformerBlock', params:{heads:8, headdim:64, ff:1024, 'param-cross':true}}, {type:'LayerNorm', params:{}} ];
      } else if (name==='deepseek'){
        designer.layers = [ {type:'Embedding', params:{vocab:50000, units:256}}, {type:'PositionalEncoding', params:{maxlen:1024, units:256}}, {type:'TransformerBlock', params:{heads:16, headdim:64, ff:2048, 'param-dropout':0.1}}, {type:'TransformerBlock', params:{heads:16, headdim:64, ff:2048, 'param-dropout':0.1}}, {type:'TransformerBlock', params:{heads:16, headdim:64, ff:2048, 'param-dropout':0.1}}, {type:'LayerNorm', params:{}} ];
      }
      renderLayersList(); renderCanvas(); appState.modelDesigned = true;
    }

    // --- Layers list rendering & interactions ---
    function renderLayersList(){
      const container = document.getElementById('layers-list'); container.innerHTML = '';
      designer.layers.forEach((layer, idx)=>{
        const row = document.createElement('div'); row.className = 'flex items-center justify-between bg-slate-700 rounded p-2 mb-2';
        const left = document.createElement('div'); left.innerHTML = `<div class="font-semibold">${idx+1}. ${layer.type}</div><div class="text-xs text-gray-300">${Object.entries(layer.params||{}).slice(0,4).map(([k,v])=>`<span class=\"param-key\">${k}</span>: ${v}`).join(' • ')}</div>`;
        const right = document.createElement('div'); right.className='flex gap-2 items-center';
        const up = document.createElement('button'); up.className='text-sm text-blue-300'; up.innerHTML='↑'; up.onclick = ()=>{ if (idx>0){ [designer.layers[idx-1],designer.layers[idx]]=[designer.layers[idx],designer.layers[idx-1]]; renderLayersList(); renderCanvas(); } };
        const down = document.createElement('button'); down.className='text-sm text-blue-300'; down.innerHTML='↓'; down.onclick = ()=>{ if (idx<designer.layers.length-1){ [designer.layers[idx+1],designer.layers[idx]]=[designer.layers[idx],designer.layers[idx+1]]; renderLayersList(); renderCanvas(); } };
        const edit = document.createElement('button'); edit.className='text-sm text-yellow-300'; edit.innerHTML='Edit'; edit.onclick = ()=> openEditor(idx);
        const clone = document.createElement('button'); clone.className='text-sm text-green-300'; clone.innerHTML='Clone'; clone.onclick = ()=>{ designer.layers.splice(idx+1,0, JSON.parse(JSON.stringify(layer))); renderLayersList(); renderCanvas(); };
        const remove = document.createElement('button'); remove.className='text-sm text-red-400'; remove.innerHTML='Remove'; remove.onclick = ()=>{ designer.layers.splice(idx,1); renderLayersList(); renderCanvas(); };
        right.appendChild(up); right.appendChild(down); right.appendChild(edit); right.appendChild(clone); right.appendChild(remove);
        row.appendChild(left); row.appendChild(right); container.appendChild(row);
      });
    }

    // --- Canvas rendering (SVG) with basic connections ---
    function renderCanvas(){
      const svg = document.getElementById('canvas-svg');
      const w = Math.max(1200, designer.layers.length * 220 + 200);
      svg.setAttribute('width', w); svg.innerHTML = '';
      const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
      const marker = document.createElementNS('http://www.w3.org/2000/svg','marker'); marker.setAttribute('id','arrow'); marker.setAttribute('markerWidth','10'); marker.setAttribute('markerHeight','10'); marker.setAttribute('refX','10'); marker.setAttribute('refY','5'); marker.setAttribute('orient','auto');
      const path = document.createElementNS('http://www.w3.org/2000/svg','path'); path.setAttribute('d','M0,0 L10,5 L0,10 Z'); path.setAttribute('fill','#94a3b8'); marker.appendChild(path); defs.appendChild(marker); svg.appendChild(defs);

      designer.layers.forEach((layer, i)=>{
        const x = 20 + i * 220; const y = 40;
        const g = document.createElementNS('http://www.w3.org/2000/svg','g'); g.setAttribute('transform', `translate(${x},${y})`); g.classList.add('layer-box');
        const rect = document.createElementNS('http://www.w3.org/2000/svg','rect'); rect.setAttribute('width',200); rect.setAttribute('height',120); rect.setAttribute('rx',8); rect.setAttribute('fill','#0b1220'); rect.setAttribute('stroke','#334155'); rect.setAttribute('stroke-width',1);
        g.appendChild(rect);
        const title = document.createElementNS('http://www.w3.org/2000/svg','text'); title.setAttribute('x',12); title.setAttribute('y',28); title.setAttribute('fill','#e2e8f0'); title.setAttribute('font-size',14); title.textContent = layer.type; g.appendChild(title);
        const ptext = document.createElementNS('http://www.w3.org/2000/svg','text'); ptext.setAttribute('x',12); ptext.setAttribute('y',48); ptext.setAttribute('fill','#94a3b8'); ptext.setAttribute('font-size',11);
        ptext.textContent = Object.keys(layer.params||{}).slice(0,3).map(k=>`${k}:${layer.params[k]}`).join(' | ');
        g.appendChild(ptext);
        g.addEventListener('click', ()=> openEditor(i)); svg.appendChild(g);

        // draw connection from previous
        if (i>0){ const x1 = 20 + (i-1)*220 + 200; const y1 = y + 60; const x2 = x; const y2 = y + 60; const line = document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('x1', x1); line.setAttribute('y1', y1); line.setAttribute('x2', x2); line.setAttribute('y2', y2); line.setAttribute('stroke','#475569'); line.setAttribute('stroke-width','2'); line.setAttribute('marker-end','url(#arrow)'); svg.appendChild(line); }
      });
    }

    // --- Editor modal ---
    function openEditor(idx){ editingIndex = idx; const layer = designer.layers[idx]; const editor = document.getElementById('layer-editor'); const body = document.getElementById('editor-body'); const title = document.getElementById('editor-title'); title.textContent = `Edit Layer — ${layer.type}`; body.innerHTML = '';
      // build inputs for each param
      for (const k in layer.params){ const v = layer.params[k]; const wrapper = document.createElement('div'); wrapper.className='text-sm'; const lab = document.createElement('label'); lab.className='block text-gray-300'; lab.textContent = k; let inp; if (typeof v === 'boolean'){ inp = document.createElement('input'); inp.type='checkbox'; inp.checked = v; inp.dataset.key = k; } else { inp = document.createElement('input'); inp.type='text'; inp.value = v; inp.dataset.key = k; inp.className='w-full bg-slate-700 p-2 rounded mt-1'; } wrapper.appendChild(lab); wrapper.appendChild(inp); body.appendChild(wrapper); }
      // add new param inputs
      const newWrap = document.createElement('div'); newWrap.className='text-sm mt-2'; newWrap.innerHTML = `<label class="block text-gray-300">New param key</label><input id="new-param-key" class="w-full bg-slate-700 p-2 rounded mt-1" />`;
      const newValWrap = document.createElement('div'); newValWrap.className='text-sm mt-2'; newValWrap.innerHTML = `<label class="block text-gray-300">Value</label><input id="new-param-val" class="w-full bg-slate-700 p-2 rounded mt-1" />`;
      body.appendChild(newWrap); body.appendChild(newValWrap);
      editor.classList.remove('hidden');
    }

    document.getElementById('editor-cancel').addEventListener('click', ()=>{ document.getElementById('layer-editor').classList.add('hidden'); editingIndex=-1; });
    document.getElementById('editor-clone').addEventListener('click', ()=>{ if (editingIndex<0) return; const clone = JSON.parse(JSON.stringify(designer.layers[editingIndex])); designer.layers.splice(editingIndex+1,0,clone); renderLayersList(); renderCanvas(); document.getElementById('layer-editor').classList.add('hidden'); editingIndex=-1; });
    document.getElementById('editor-save').addEventListener('click', ()=>{ const editor = document.getElementById('layer-editor'); if (editingIndex<0) return; const layer = designer.layers[editingIndex]; const inputs = editor.querySelectorAll('[data-key]'); inputs.forEach(inp=>{ const key = inp.dataset.key; if (inp.type === 'checkbox') layer.params[key] = inp.checked; else if (!isNaN(parseFloat(inp.value)) && inp.value !== '') layer.params[key] = parseFloat(inp.value); else layer.params[key] = inp.value; }); const newKey = document.getElementById('new-param-key').value.trim(); const newVal = document.getElementById('new-param-val').value; if (newKey) { layer.params[newKey] = (newVal!=='' && !isNaN(parseFloat(newVal)))?parseFloat(newVal):newVal; } editor.classList.add('hidden'); editingIndex=-1; renderLayersList(); renderCanvas(); });

    // --- Export / Import / Local Storage ---
    document.getElementById('export-json-btn').addEventListener('click', ()=>{ const blob = new Blob([JSON.stringify({layers:designer.layers},null,2)],{type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download='model-design.json'; a.click(); URL.revokeObjectURL(url); });
    document.getElementById('import-json-btn').addEventListener('click', ()=> document.getElementById('import-json').click());
    document.getElementById('import-json').addEventListener('change', (e)=>{ const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = ()=>{ try{ const data = JSON.parse(r.result); if (data.layers) designer.layers = data.layers; else if (Array.isArray(data)) designer.layers = data; renderLayersList(); renderCanvas(); } catch(err){ alert('Invalid JSON'); } }; r.readAsText(f); });

    document.getElementById('save-local-btn').addEventListener('click', ()=>{ localStorage.setItem('neuralforge.design', JSON.stringify(designer.layers)); alert('Saved locally'); });
    document.getElementById('load-local-btn').addEventListener('click', ()=>{ const raw = localStorage.getItem('neuralforge.design'); if (!raw) return alert('No saved design'); try{ designer.layers = JSON.parse(raw); renderLayersList(); renderCanvas(); } catch(e){ alert('Failed to load'); } });

    // Export PNG
    document.getElementById('export-png').addEventListener('click', ()=>{ const svg = document.getElementById('canvas-svg'); const xml = new XMLSerializer().serializeToString(svg); const blob = new Blob([xml],{type:'image/svg+xml'}); const url = URL.createObjectURL(blob); const img = new Image(); img.onload = ()=>{ const c = document.createElement('canvas'); c.width = svg.width.baseVal.value; c.height = svg.height.baseVal.value; const ctx = c.getContext('2d'); ctx.fillStyle = '#0b1220'; ctx.fillRect(0,0,c.width,c.height); ctx.drawImage(img,0,0); c.toBlob(b=>{ const u = URL.createObjectURL(b); const a = document.createElement('a'); a.href = u; a.download='canvas.png'; a.click(); URL.revokeObjectURL(u); }, 'image/png'); URL.revokeObjectURL(url); }; img.src = url; });

    document.getElementById('clear-canvas').addEventListener('click', ()=>{ if (confirm('Clear design?')){ designer.layers = []; renderLayersList(); renderCanvas(); appState.modelDesigned=false; } });

    // --- Init ---
    function init(){ renderLayersList(); renderCanvas(); }
    window.addEventListener('DOMContentLoaded', ()=>{ init(); document.querySelectorAll('.nav-link').forEach(link=>{ link.addEventListener('click',(e)=>{ e.preventDefault(); const id = link.getAttribute('href').substring(1); showSection(id); }); }); });

    // --- Quick copyDesign for top buttons ---
    function copyDesign(type){ if (type==='transformer_encoder') applyPreset('bert'); else if (type==='transformer_decoder') applyPreset('gpt-lite'); else if (type==='transformer_ed') applyPreset('t5'); else if (type==='deepseek') applyPreset('deepseek'); renderLayersList(); renderCanvas(); }
    window.copyDesign = copyDesign; window.applyPreset = applyPreset;

  </script>
</body>
</html>
